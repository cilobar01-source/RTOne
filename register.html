<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Daftar Akun ¬∑ Portal RT Cilosari Barat</title>
  <link rel="stylesheet" href="style.css">

  <style>
    .valid { border: 2px solid #16a34a; }  /* hijau */
    .invalid { border: 2px solid #dc2626; } /* merah */
    .message { font-size: 0.9em; color: #dc2626; }
  </style>

  <script type="module">
  import { sb } from './script.js';

  const form = document.getElementById('f');
  const emailInput = document.getElementById('email');
  const passInput = document.getElementById('password');
  const msg = document.getElementById('msg');

  // üîç Cek email saat diketik
  emailInput.addEventListener('input', ()=>{
    const email = emailInput.value.trim().toLowerCase();
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    if(emailRegex.test(email)){
      emailInput.classList.add('valid');
      emailInput.classList.remove('invalid');
      msg.textContent = "";
    } else {
      emailInput.classList.add('invalid');
      emailInput.classList.remove('valid');
      msg.textContent = "‚ö†Ô∏è Format email tidak valid! Contoh: nama@gmail.com";
    }
  });

  // üîí Cek password minimal 6 karakter
  passInput.addEventListener('input', ()=>{
    if(passInput.value.length >= 6){
      passInput.classList.add('valid');
      passInput.classList.remove('invalid');
    } else {
      passInput.classList.add('invalid');
      passInput.classList.remove('valid');
    }
  });

  // üöÄ Proses Submit
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const nama = f.nama.value.trim();
    const email = f.email.value.trim().toLowerCase();
    const password = f.password.value.trim();

    if(!nama || !email || !password){
      alert("‚ö†Ô∏è Lengkapi semua data terlebih dahulu!");
      return;
    }

    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    if(!emailRegex.test(email)){
      alert("‚ö†Ô∏è Email tidak valid! Gunakan format: nama@gmail.com");
      return;
    }

    if(password.length < 6){
      alert("‚ö†Ô∏è Kata sandi minimal 6 karakter!");
      return;
    }

    // Daftar ke Supabase
    const { data, error } = await sb.auth.signUp({
      email: email,
      password: password,
      options: { data: { nama } }
    });

    if(error){
      alert("‚ùå Pendaftaran gagal: " + error.message);
      console.error(error);
      return;
    }

    const userId = data?.user?.id;
    if(!userId){
      alert("‚ùå Gagal mendapatkan ID pengguna baru.");
      return;
    }

    // Simpan ke tabel profiles
    const { error: errProfile } = await sb.from("profiles").insert([
      { id: userId, email: email, role: "WARGA" }
    ]);

    if(errProfile){
      alert("‚ùå Gagal menyimpan profil: " + errProfile.message);
      console.error(errProfile);
      return;
    }

    alert("‚úÖ Pendaftaran berhasil! Silakan login dengan akun Anda.");
    window.location.href = "login.html";
  });
  </script>
</head>

<body>
  <header class="header">
    <div class="brand">
      <img class="logo" src="assets/icon-192.png" alt="Logo RT">
      <div>
        <h1>Daftar Akun Baru</h1>
        <p>Portal RT01 / RW08 Cilosari Barat</p>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <form id="f" class="grid">
        <input class="input" name="nama" type="text" placeholder="Nama Lengkap" required>
        <input class="input" id="email" name="email" type="email" placeholder="Alamat Email (contoh: nama@gmail.com)" required>
        <input class="input" id="password" name="password" type="password" placeholder="Kata Sandi (min. 6 karakter)" minlength="6" required>
        <p id="msg" class="message"></p>
        <button class="btn" type="submit">Daftar Sekarang</button>
      </form>

      <p style="text-align:center;margin-top:10px">
        Sudah punya akun? <a href="login.html">Masuk di sini</a>
      </p>
    </div>
  </main>

  <footer class="footer">
    <small>¬© 2025 Portal RT Cilosari Barat ¬∑ v3.0 Smart Validation</small>
  </footer>
</body>
</html>
